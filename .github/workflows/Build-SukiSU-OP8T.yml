name: Build OnePlus 8T Kernel

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *' # 每天 UTC 0 点触发

env:
  KERNEL_REPO: https://github.com/LineageOS/android_kernel_oneplus_sm8250.git
  KERNEL_BRANCH: lineage-23.0
  DEVICE: vendor/kebab_defconfig
  SUSFS: none       # none/main/dev 可选
  KPM: false

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout Kernel Source
        uses: actions/checkout@v3
        with:
          repository: ${{ env.KERNEL_REPO }}
          ref: ${{ env.KERNEL_BRANCH }}
          path: kernel_workspace

      - name: Setup Build Environment
        run: |
          sudo apt-get update -y
          sudo apt-get install -y git clang llvm lld make gcc g++ bc bison flex \
            libssl-dev libelf-dev libncurses5-dev libncursesw5-dev unzip \
            python3 python3-pip wget curl zip \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            gcc-arm-linux-gnueabi g++-arm-linux-gnueabi

          # 下载官方 clang 预编译版本
          mkdir -p $HOME/toolchains
          cd $HOME/toolchains
          wget https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/master/clang-r530567.tar.gz -O clang.tar.gz
          mkdir clang && tar -xf clang.tar.gz -C clang
          echo "export PATH=$HOME/toolchains/clang/bin:\$PATH" >> $GITHUB_ENV
          echo "export CROSS_COMPILE=aarch64-linux-gnu-" >> $GITHUB_ENV
          echo "export ARCH=arm64" >> $GITHUB_ENV

      - name: Configure Kernel
        working-directory: kernel_workspace
        run: |
          make O=out $DEVICE

          # SUSFS/KPM 配置
          if [[ "${SUSFS}" != "none" ]]; then
            echo "Configuring SUSFS mode: ${SUSFS}"
            # 这里可以写实际修改 .config 的逻辑
          fi

          if [[ "${KPM}" == "true" ]]; then
            echo "Enabling KPM"
            # 这里可以写实际修改 .config 的逻辑
          fi

      - name: Build Kernel
        working-directory: kernel_workspace
        run: |
          make -j$(nproc) O=out \
            CC=clang \
            LD=ld.lld \
            CROSS_COMPILE=${CROSS_COMPILE}

      - name: Package Kernel
        working-directory: kernel_workspace
        run: |
          mkdir -p kernel_package
          cp out/arch/arm64/boot/Image.gz-dtb kernel_package/
          zip -r kernel_package.zip kernel_package

      - name: Upload Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: kernel-package
          path: kernel_workspace/kernel_package.zip
